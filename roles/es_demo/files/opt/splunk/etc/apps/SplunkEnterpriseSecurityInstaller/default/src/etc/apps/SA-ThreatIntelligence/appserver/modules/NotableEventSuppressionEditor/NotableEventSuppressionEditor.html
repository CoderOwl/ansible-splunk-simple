<%# Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

import logging
import os
import sys

sys.path.append( os.path.join("..", "..", "..", "bin") )

from NotableEventSuppressionEditor import none_to_default, output_if_true
from notable_event_suppression import NotableEventSuppression

logger = logging.getLogger('splunk.appserver.SA-ThreatIntelligence.modules.NotableEventSuppressionEditor')

## Get cherry key
session_key = cherrypy.session.get('sessionKey')

## Get cherry username
user = cherrypy.session['user']['name']

## Get capabilities
capabilities = NotableEventSuppression.getCapabilities4User(user, session_key)

## Test capabilities
insufficient_permissions = True

if 'edit_suppressions' in capabilities:
    insufficient_permissions = False

# Get the arguments
args = cherrypy.serving.request.params

messages = []

# Get the form action URL
form_action = make_url(["module", "system", "Splunk.Module.NotableEventSuppressionEditor", "render"]);

# Get the app name
app = APP['id']

# Get the search if provided
if 'search' in args:
	search = args['search']
else:
	search = ""
	
# Get the suggested name if it is defined
if 'name' in args:
	name = args['name']
	
	name = NotableEventSuppression.generate_suppression_name(name)
	
else:
	name=""

# Get the description if provided
if 'description' in args:
	description = args['description']
else:
	description = ""

# Get the suppression to edit
if 'id' in args:
	suppression = NotableEventSuppression.get_notable_suppression(id=args['id'])
	is_new = False
else:
	suppression = NotableEventSuppression(name, True, description, search)
	is_new = True

# Determine if this is being populated from a wizard based 
wizard_mode = 'wz' in args

# Get the search description if provided
if 'search_description' in args:
	search_description = args['search_description']
else:
	search_description = None

%>
<%page args="module"/>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine-en.js'])}" type="text/javascript" charset="utf-8"></script>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine.js'])}" type="text/javascript" charset="utf-8"></script>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/ui.dropdownchecklist-1.4-min.js'])}" type="text/javascript" ></script>

<script type="text/javascript">
	$(document).ready(function() {
		$("#eaiform").validationEngine();
		$( "#form_datetime" ).datepicker({
            currentText: '',
			prevText: '',
			nextText: '',
			minDate: '+1d'
        });
		//$('#form_name').default_text("Enter a unique name for the suppression rule");
	});
</script>

<style>
@import url("${make_url(['/static/css/admin.css'])}");
@import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/validationEngine.jquery.css'])}" );
@import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/ui.dropdownchecklist.standalone.css'])}" );

.Message {
    padding: 0;
}

#es_no_permissions div.adminGroup {
  border: none;
  box-shadow: none;
  padding: 0px;
}

#es_no_permissions div.adminListItem {
  border-bottom: none;
  min-height: 45px;
  padding-left: 15px;
}

#es_no_permissions dd {
  border-left: none;
  padding-top: 16px;
}
</style>

% if not insufficient_permissions:
  <form autocomplete="off" enctype="multipart/form-data" action="${form_action}" method="get" class="entityEditForm" id="eaiform">
  
  % if not is_new:
  	<input type="hidden" value="${args['id'] | h}" name="id" />
  	<fieldset><legend style="padding: 0px 0px 0px 10px;">Edit Notable Event Suppression</legend></fieldset>
  % else:
  	<fieldset><legend style="padding: 0px 0px 0px 10px;">New Notable Event Suppression</legend></fieldset>
  % endif
  
  	<div id="item-basicgroup" class="fieldsetWrapper">
      	<fieldset id="">
  
  		## ---------------------------
      	## Name
  		## ---------------------------
              <div class="" id="label">
              	<label class="">Name</label>
      			<div>
  					<div class="widgeterror"></div>
  					
  					<input type="text" ${output_if_true('disabled="true"', not is_new)} value="${none_to_default(suppression.name) | h}" id="form_name" name="name" placeholder="Enter a unique name without spaces or special characters." class="validate[required,custom[validStanza]]"/>
  					% if not is_new:
  					<input type="hidden" name="name" value="${none_to_default(suppression.name) | h}" />
  					% endif
         			</div>
      		</div>
  
  		## ---------------------------
      	## Description
  		## ---------------------------
              <div class="" id="label">
              	<label class="">Description <span class="optionalText">(optional)</span></label>
      			<div>
  					<div class="widgeterror"></div>
  					<textarea type="text" id="form_description" name="description" class="regular normalFont" placeholder="Enter a description of the suppression rule (optional)">${none_to_default(suppression.description) | h}</textarea>
         			</div>
      		</div>
  
  		## ---------------------------
      	## Search
  		## ---------------------------
              <div class="" id="label">
              	<label class="">Search 
             			% if wizard_mode:
             				<span class="optionalText">(automatically populated)</span>
             			% endif
             		</label>
      			<div>
  					<div class="widgeterror"></div>
  					<textarea id="form_search" name="search${output_if_true('_display', wizard_mode)}" ${output_if_true('disabled="true"', wizard_mode)} class="regular validate[required]">${none_to_default(suppression.search) | h}</textarea>
  					% if wizard_mode:
  					<input type="hidden" name="search" value="${suppression.search | h}" />
  					% endif
         			</div>
  				% if search_description is not None:
  				<p class="exampleText"><em>${search_description|h}</em></p>
  				% endif
      		</div>
  
  		## ---------------------------
      	## Date/time
  		## ---------------------------
  		% if is_new:
  		 <!-- class="validate[required,custom[date],future[now]]"  -->
            <div class="" id="label">
              	<label class="">Expiration Time <span class="optionalText">(optional)</span></label>
      			<div>
  					<div class="widgeterror"></div>
  					<input type="text" value="" id="form_datetime" name="expiration_date" />
         			</div>
         			<p class="exampleText"><em>The expiration time defines when the suppression will end; events after this time will not be suppressed.</em></p>
            </div>
      	% endif
      	
  		## ---------------------------
      	## Hidden meta fields
  		## ---------------------------
  			<input type="hidden" value="${app | h}" name="app" id="app" />
            <input type="hidden" value="${user | h}" name="user" id="user" />
  		% if is_new and 'start_time' in args and len(args['start_time']) > 0:
  			<input type="hidden" value="${args['start_time'] | h}" name="start_time" id="start_time" />
  		% endif
      	
      	</fieldset>
      </div>
  
  	<div class="jmFormActions">
  		<button type="button" id="cancel_button" class="splButton-secondary"><span>Cancel</span></button>
          <button class="splButton-primary" type="submit"><span id="save_button">Save</span></button>
      </div>
  
  </form>
% else:
  <div class="adminContent">
    <div class="adminIndex" id="es_no_permissions">
      <div class="adminGroup">
        <div class="adminListItem">
          <a class="adminListIcon" style="background: url(${make_url(['static','img','skins','default','managerIcons','icon_access.png'])}) no-repeat 0px 0;"></a>
          <dd>You do not have the necessary capabilities required to edit Notable Event Suppressions.  Please contact your Splunk administrator.</dd>
        </div>
      </div>
    </div>
  </div>
% endif