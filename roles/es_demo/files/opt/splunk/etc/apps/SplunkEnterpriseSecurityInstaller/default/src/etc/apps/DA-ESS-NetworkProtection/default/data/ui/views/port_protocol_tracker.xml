<form script="port_protocol_tracker.js">
	<label>Port &amp; Protocol Tracker</label>
	
	<fieldset autoRun="true" submitButton="true">
        <input type="text" token="bunit_form">
            <label>Business Unit</label>
            <default></default>
        </input>

        <input type="dropdown" token="category_form">
            <label>Category</label>
            <choice value="">All</choice>
            <populatingSearch fieldForValue="category" fieldForLabel="category">| `categories`</populatingSearch>
            <default></default>
        </input>
	</fieldset>

	<row>
		<panel>
			<input type="dropdown" token="transport" searchWhenChanged="true">
	            <label>Transport</label>
	            <populatingSearch fieldForValue="transport" fieldForLabel="transport">| `cim_transport_protocols`</populatingSearch>
	            <default>tcp</default>
	            <prefix>All_Traffic.transport="</prefix>
	            <suffix>"</suffix>
	        </input>

	        <input type="text" token="dest_port" searchWhenChanged="true">
	            <label>Destination Port</label>
	            <default>80</default>
	            <prefix>All_Traffic.dest_port="</prefix>
	            <suffix>"</suffix>
	        </input>

	        <chart id="element1">
	            <title>Port/Protocol Profiler</title>
	            
	            <searchTemplate>| tstats `summariesonly` count from datamodel=Network_Traffic where $transport$ $dest_port$ $bunit$ $category$ by _time,All_Traffic.transport,All_Traffic.dest_port span=1d | `drop_dm_object_name("All_Traffic")` | `get_transport_dest_port` | `dayDiff` | eval last60=if(dayDiff>1 AND dayDiff&lt;=60,count,null()) | eval last7=if(dayDiff&gt;1 AND dayDiff&lt;=7,count,null()) | eval today=if(dayDiff&lt;=1,count,null()) | stats avg(last60) as "Last 60 days",avg(last7) as "Last 7 days",sum(today) as "Today" by transport_dest_port</searchTemplate>
	            
	            <option name="charting.axisTitleX.text">time</option>
	            <option name="charting.axisTitleY.text">average / day</option>
	            <option name="charting.chart">column</option>
	            <option name="charting.legend.placement">bottom</option>
	
	            <drilldown>
	                <link>search?q=| `datamodel("Network_Traffic","All_Traffic")` | `drop_dm_object_name("All_Traffic")` | `get_transport_dest_port` | search transport_dest_port="$click.value$"&amp;earliest=-24h@h&amp;latest=now</link>
	            </drilldown>
	        
	        </chart>
        </panel>
        <panel>
        	<table id="element2">
				<title>New Port Activity - Last 7 Days</title>
				
				<searchName>Traffic - New Port Activity</searchName>
				
				<drilldown>
					<link>traffic_search?form.transport=$row.transport$&amp;form.dest_port=$row.dest_port$</link>
				</drilldown>
			</table>
        </panel>
	</row>
	
	<row>
		<chart id="element3">
		    <title>Prohibited Or Insecure Traffic Over Time - Last 24 Hours</title>
            
            <earliestTime>-24h@h</earliestTime>
            <latestTime>now</latestTime>
            <searchTemplate>| tstats `summariesonly` values(All_Traffic.src_category) as src_category,values(All_Traffic.dest_category) as dest_category,count from datamodel=Network_Traffic where * $bunit$ $category$ by _time,All_Traffic.src,All_Traffic.dest,All_Traffic.transport,All_Traffic.dest_port span=10m | `drop_dm_object_name("All_Traffic")` | `is_traffic_prohibited(dest_port)` | search (is_prohibited!="false" OR is_secure!="unknown") | `get_transport_dest_port` | timechart minspan=10m sum(count) as count by transport_dest_port</searchTemplate>
            
            <option name="charting.axisTitleX.text">time</option>
            <option name="charting.axisTitleY.text">count</option>
            <option name="charting.chart">line</option>
            <option name="charting.chart.nullValueMode">zero</option>

            <drilldown>
                <link>search?q=| `datamodel("Network_Traffic","All_Traffic")` | `drop_dm_object_name("All_Traffic")` | `get_transport_dest_port` | search transport_dest_port="$click.name2$"&amp;earliest=$earliest$&amp;latest=$latest$</link>
            </drilldown>
		</chart>
	</row>

	<row>
		<table id="element4">
			<title>Prohibited Traffic Details - Last 24 Hours</title>
			
			<earliestTime>-24h@h</earliestTime>
			<latestTime>now</latestTime>
			<searchTemplate>| tstats `summariesonly` max(_time) as _time,values(All_Traffic.src_category) as src_category,values(All_Traffic.dest_category) as dest_category,count from datamodel=Network_Traffic where * $bunit$ $category$ by All_Traffic.src,All_Traffic.dest,All_Traffic.transport,All_Traffic.dest_port | `drop_dm_object_name("All_Traffic")` | `is_traffic_prohibited(dest_port)` | search (is_prohibited!="false" OR is_secure!="unknown") | fields _time,src,src_category,dest,dest_category,transport,dest_port,is_prohibited,is_secure</searchTemplate>
		
		    <drilldown>
                <link>search?q=| `datamodel("Network_Traffic","All_Traffic")` | `drop_dm_object_name("All_Traffic")` | search src="$row.src$" dest="$row.dest$" transport="$row.transport$" dest_port="$row.dest_port$"&amp;earliest=$earliest$&amp;latest=$latest$</link>
            </drilldown>
		</table>
	</row>

</form>