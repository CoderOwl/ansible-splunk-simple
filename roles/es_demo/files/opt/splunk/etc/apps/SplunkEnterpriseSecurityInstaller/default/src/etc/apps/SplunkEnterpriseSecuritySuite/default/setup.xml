<setup>
    <block title="Splunk App for Enterprise Security Setup">
        <text>
        
            <![CDATA[
            <style>
                #item-blockFieldset-0 legend {
                    font-size: 13pt;
                }
        
                /* Hide the "Run the Enterprise Security Installer" box */
                div[id="item-/admin/enterprise_security_suite/general_settings/ESS_do_install"] {
                    display: none;
                }
        
                #eaiform > h2 {
                    display: none;
                }
                
                .setup-description > dt{
                    font-weight: bold;
                }
                
                .setup-description > dd{
                    border-left: 4px solid #DDD;
                    margin-left: 10px;
                    padding-left: 5px;
                    margin-bottom: 8px;
                }
                
            </style>
      
            <script type="text/javascript">
                function openAppPage( appname ){
                    if( is42plus() ){
                        link = "/manager/appinstall/" + appname; //"?return_to=%2Fmanager%2FSplunkEnterpriseSecuritySuite%2Fapps%2Flocal%2FSplunkEnterpriseSecuritySuite%2Fsetup%3Faction%3Dedit";
                        window.open(location.protocol + "//" + location.host + link);
                        //window.open(location.protocol + "//" + location.host +  "/manager/launcher/apps/remote?q=" + appname);
                        return false;
                    }
                    else{
                        return true;
                    }
                }
                
                function is42plus(){
                    var version_re = /Splunk ([0-9]+)([.]([0-9]+))?/;
                    var title = $('title').text();
                    var m = version_re.exec(title);
                    
                    if( m == null || m.length < 4 ){
                        return false;
                    }
                    
                    var major = parseInt(m[1], 10);
                    var minor = parseInt(m[3], 10);
                    
                    if( major > 4 || (major == 4 && minor >= 2 ) ){
                        return true;
                    }
                    
                    return false;
                }
        
            </script>

            ]]>
      
            <![CDATA[
            The Splunk App for Enterprise Security has been successfully installed.
            A few additional steps are required to optimize Enterprise Security for Splunk.
            Review the steps below and when you have made your selections, click <b>Save</b> to complete the setup. 
            ]]>
            
            <![CDATA[
            <p>
            If you need help, please <a target="_blank" href="http://www.splunk.com/support">contact support.</a>
            </p>
            ]]>
            
        </text>
    </block>
    
    <block title="Realtime" endpoint="/configs/conf-limits/" >
        <text>
            <![CDATA[
            Indexed real time allows real time searches to be multi-tasked for greatly increased performance. See <a target="_blank" href="http://docs.splunk.com/Documentation/Splunk/latest/Search/Aboutrealtimesearches">About realtime searches</a> for more information on this topic.
            ]]>
        </text>
        
        <input entity="realtime" field="indexed_realtime_use_by_default">
            <label>Enable Indexed Realtime</label>
            <type>bool</type>
        </input>
        
        <input entity="realtime" field="indexed_realtime_disk_sync_delay">
            <label>Number of seconds to wait for disk flushes to finish with</label>
            <type>text</type>
            <validation>\d+</validation>
        </input>
    </block>
  
    <block title="Search Job Quota Configuration" endpoint="admin/roles/" >
        <text>
            <![CDATA[
            To improve the performance of the Enterprise Security app views, we recommend that you increase the search job and disk quotas (the number of concurrent searches and the amount of disk spaced allowed respectively).
            Set the admin and power user concurrent search job quota to 10 or more.
            Set the admin search disk quota to 25 gigabytes or more.
            <p>
            The settings below show your current configuration. Review these settings and update them if necessary.
            </p>
            <a target="_blank" href="http://www.splunk.com/base/Documentation/latest/admin/Authorizeconf#authorize.conf.spec">View more information about search job quotas.</a>
            ]]>
        </text>
        
        <input entity="admin" field="srchDiskQuota">
            <label>Maximum amount of disk space (MB) that can be used for search jobs by the $name$ user</label>
            <type>text</type>
            <validation>\d+</validation>
        </input>
        
        <input entity="admin" field="srchJobsQuota">
            <label>Maximum number of concurrent searches for the $name$ user</label>
            <type>text</type>
            <validation>\d+</validation>
        </input>
      
        <input entity="power" field="srchJobsQuota">
            <label>Maximum number of concurrent searches for the $name$ user</label>
            <type>text</type>
            <validation>\d+</validation>
      </input>
    </block>
  
    <block title="Finalize Setup">
        <text>
            <![CDATA[
            To complete the Enterprise Security app setup the setup mechanism needs to perform some final steps.  When you click <b>Save</b> the setup mechanism will do the following:
            
            <dl class="setup-description">
              <dt>Deploy OS-specific versions of the scripted inputs and README files</dt>
                <dd>
                Windows uses different path separators than UNIX.
                If Enterprise Security is installed on a Windows platform, some default configuration files will be replaced with files that use Windows path separators.
                Windows also requires a filename extension to assign a default application.
                Setup will add a .txt extension to README files if your application platform is Windows.
                </dd>
              <dt>Deploy default lookups</dt>
                <dd>
                A number of default lookup files need to be available for Enterprise Security to function properly.
                Default files will be deployed if they do not already exist from a previous deployment of Enterprise Security app (pre-existing lookup files will not be modified).
                </dd>
              <dt>Deploy FIPS compliant settings</dt>
                <dd>
                FIPS compliance regulations disallow the use of certain encryption algorithms.
                If this Splunk installation has been previously configured for FIPS compliance, Setup will ensure that only FIPS-compliant algorithms are used in the Enterprise Security app.
                </dd>
            </dl>
            ]]>

            <![CDATA[
            <script>
            function addJavascript( filename ){
            
                filename = Splunk.util.make_url(filename);
            
                var script = $("<script>");
                script.attr({type: 'text/javascript', src: filename});
                $("head").append( script );
            }
            
            function addStylesheet( filename ){
            
                filename = Splunk.util.make_url(filename);
            
                // For Internet Explorer, use createStyleSheet since adding a stylesheet using a link tag will not be recognized
                // (http://stackoverflow.com/questions/1184950/dynamically-loading-css-stylesheet-doesnt-work-on-ie)
                if( document.createStyleSheet ){
                    document.createStyleSheet(filename);
                }
                // For everyone else
                else{
                    var link = $("<link>");
                    link.attr({type: 'text/css',rel: 'stylesheet', href: filename});
                    $("head").append( link );
                }
            }
            
            addStylesheet('/static/app/SplunkEnterpriseSecuritySuite/validationEngine.jquery.css');
            addJavascript('/static/app/SplunkEnterpriseSecuritySuite/jquery.validationEngine-en.js');
            addJavascript('/static/app/SplunkEnterpriseSecuritySuite/jquery.validationEngine.js');
            
            function getConfigURL(){
                return Splunk.util.make_url("/app/SplunkEnterpriseSecuritySuite/ess_configuration");
            }
            
            function redirectToConfig(){
                window.location.assign( getConfigURL() );
            }
            
            function setRedirectURL(){
            
               if( window.location.search != null && window.location.search.indexOf("redirected") >= 0 ){
                  return;
               }
            
               tmp = window.location.search.split("&");
               has_redirect_already = false;
               
               for (c = 0; c < tmp.length; c++){
                  if( tmp[c].indexOf( "redirect_override" ) >= 0 && ( tmp[c].indexOf("/app/SplunkEnterpriseSecuritySuite/ess_configuration") >= 0 || tmp[c].indexOf("%2Fapp%2FSplunkEnterpriseSecuritySuite%2Fess_configuration") >= 0 ) ){
                    has_redirect_already = true;
                  }
               }
            
               if( has_redirect_already == false ){
                  window.location.assign( Splunk.util.make_url( "/manager/SplunkEnterpriseSecuritySuite/apps/local/SplunkEnterpriseSecuritySuite/setup?action=edit&redirected=true&redirect_override=" + getConfigURL() ) );
               }
               
            }
            
            setRedirectURL();
            
            function stopSaveIfValidationFails(){
              
                // First, try the validation engine check
                validation = $("#eaiform").validationEngine('validate');
                
                if( validation == true ){
                    return true;
                }
                else if( validation == false ){
                    return false;
                }
            }
                        
            function configureSetupAppInputValidation(){
                $('input[name$="admin/roles/admin/srchJobsQuota"]').attr("id", "srch_jobs_admin");
                $('#srch_jobs_admin').addClass("validate[required,custom[integer],min[10]]");
                
                $('input[name$="admin/roles/power/srchJobsQuota"]').attr("id", "srch_jobs_power");
                $('#srch_jobs_power').addClass("validate[required,custom[integer],min[10]]");
                
                $('input[name$="configs/conf-limits/realtime/indexed_realtime_disk_sync_delay"]').attr("id", "indexed_realtime_disk_sync_delay");
                $('#indexed_realtime_disk_sync_delay').addClass("validate[required,custom[integer],min[0]]");
                
                $('input[name$="admin/roles/admin/srchDiskQuota"]').attr("id", "srchDiskQuota");
                $('#srchDiskQuota').addClass("validate[required,custom[integer],min[0]]");
                
                $("#eaiform").validationEngine();
                $('#eaiform').click( stopSaveIfValidationFails );
            }
                        
            $(document).ready(function(){
                configureSetupAppInputValidation();
            });
      
            //$('div[id^="item-/admin/enterprise_security_suite/general_settings/ESS_do_install"]').hide();
            </script>
            ]]>
        </text>
    </block>
  
    <block title=" " endpoint="admin/enterprise_security_suite/" entity="general_settings">
        <input field="ESS_do_install">
            <label>Run the Enterprise Security Installer</label>
            <type>bool</type>
        </input>
    </block>
  
</setup>
