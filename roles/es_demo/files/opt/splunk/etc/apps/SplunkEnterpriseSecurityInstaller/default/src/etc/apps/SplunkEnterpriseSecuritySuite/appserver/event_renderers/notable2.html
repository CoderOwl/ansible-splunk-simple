## Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

## inherit the default renderer structural elements
<%inherit file="//results/EventsViewer_default_renderer.html" />

<%! 
    def get_field_value(event, name, field_index=0):
        if name == '_raw':
            return str(event.raw)
            
        else:
            if event.fields.has_key(name) and field_index < len(event.fields[name]):
                return str(event.fields[name][field_index])
            else:
                return "unknown"
    
    def perform_substitution(event, description, addquotes=False):
        for field_name in event.fields.keys():
            if addquotes:
                value = get_field_value(event, field_name)
                value = value.replace('"', '\"')
                description = description.replace("$" + field_name + "$", '"' + value + '"')
            else:
                description = description.replace("$" + field_name + "$", get_field_value(event, field_name))
        return description
    
    def is_job_running(job):
        
        # The following maps the statuses to a field indicating if the 
        DISPATCH_STATE_MAP = {
            'QUEUED': True,
            'PARSING': True,
            'RUNNING': True,
            'FINALIZING': True,
            'DONE': False,
            'FAILED': False
        }
        
        # Note that we treat a paused state as a running state (job.isPaused). This is due to the fact that the UI still updates even when paused.
        return DISPATCH_STATE_MAP[job.dispatchState]

%>

#####################
## Event Layout
#####################
<%def name="event_layout(job, event, request, options, xslt)">
    
    <%
      event_hash = get_field_value(event, 'event_hash') 
      security_domain = get_field_value(event, 'security_domain')
      rule_name = get_field_value(event, 'rule_name')
      rule_title = perform_substitution(event, get_field_value(event, 'rule_title'))  
      urgency = get_field_value(event, 'urgency')
      severity = get_field_value(event, 'severity')
      priority = get_field_value(event, 'priority')
      status = get_field_value(event, 'status')
      status_label = get_field_value(event, 'status_label')
      status_description = get_field_value(event, 'status_description')
      owner = get_field_value(event, 'owner')
      owner_realname = get_field_value(event, 'owner_realname')
      governance = get_field_value(event, 'governance')
    %>

    <table class="mainTable">
      <tbody>
        <tr>
          <td class="col1"><%self:event_select job="${job}" event="${event}" request="${request}" options="${options}" /></td>
          <td class="col2"><%self:event_actions job="${job}" event="${event}" request="${request}" options="${options}" /></td>
          <td class="col3"><%self:event_time job="${job}" event="${event}" request="${request}" options="${options}" /></td>
          <td class="col4">
            <span class="fields header2">
              <em style="display: none;" class="k">security_domain</em>
              <em class="v">${security_domain|h}</em>&nbsp;
              % if not is_job_running(job):
                 <a href="#" class="fm">Options</a>
              % endif
            </span>
          </td>
          <td class="col5">
            <span class="fields header2">
              <em style="display: none;" class="k">rule_name</em>
              <em class="v" ess:v="${rule_name|h}">${rule_title|h}</em>&nbsp;
              % if not is_job_running(job):
                 <a href="#" class="fm">Options</a>
              % endif
            </span> 
          </td>
          <td class="col6">
            <span class="fields urgency ${urgency|h}" title="${severity|h} severity and ${priority|h} priority">
              <em style="display: none;" class="k">urgency</em>
              <em class="v">${urgency|h}</em>&nbsp;
              % if not is_job_running(job):
                 <a href="#" class="fm">Options</a>
              % endif
            </span>
          </td>
          <td class="col7">
            % if status_description == "unknown":
            <span class="fields header2">
            % else:
            <span class="fields header2 status" title="${status_description|h}">
            % endif
              <em style="display: none;" class="k">status</em>
              <em class="v" ess:v="${status|h}">${status_label|h}</em>&nbsp;
              % if not is_job_running(job):
                 <a href="#" class="fm">Options</a>
              % endif
            </span>
          </td>
          <td class="col8">        
            <span class="fields header2">
              <em style="display: none;" class="k">owner</em>
              % if owner_realname is not None and len(owner_realname)>0 and owner_realname != "unknown":
              <em class="v" ess:v="${owner|h}">${owner_realname|h}</em>&nbsp;
              % else:
              <em class="v">${owner|h}</em>&nbsp;
              % endif
              % if not is_job_running(job):
                 <a href="#" class="fm">Options</a>
              % endif
            </span>
          </td>
          <td class="col9">
            % if not is_job_running(job):
            <a href="#" onclick="return toggleIRDetails('${event_hash|h}');" id="${event_hash|h}-toggle">
              View details
            </a>
            % else:
            <a href="#" class="details_disabled" onclick="alert('The search is still running. Please finalize it first in order to display the event details.'); return false;" id="${event_hash|h}-toggle">
              View details
            </a>
            % endif
          </td>
        </tr>
      </tbody>
    </table>
    
    <div class="event_details" style="display: none;" id="${event_hash|h}">
      <table style="width: 100%; border-collapse: separate; border-spacing: 8px;">
        <tbody>
          <tr>
            <td style="border-right: 1px dotted #CCCCCC; vertical-align: top; width: 65%;">
              <table style="width: 100%;">
                <tbody>
                  % if event.fields.has_key('rule_description'):
                  <tr>
                    <td><%self:event_description job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                  % if event.fields.has_key('governance') and governance!='unknown':
                  <tr>
                    <td><%self:event_compliance job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                  <tr>
                    <td><%self:event_additional_fields job="${job}" event="${event}" request="${request}" options="${options}" xslt="${xslt}" /></td>
                  </tr>
                </tbody>
              </table>
            </td>
            <td style="vertical-align: top;">
              <table style="width: 100%;">
                <tbody>
                  % if event.fields.has_key('source'):
                  <tr>
                    <td><%self:event_source job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                  % if event.fields.has_key('rule_id'):
                  <tr>
                    <td><%self:event_edit_history job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                  % if event.fields.has_key('drilldown_search') and event.fields.has_key('drilldown_name'):
                  <tr>
                    <td><%self:event_drilldown job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % elif event.fields.has_key('drilldown_name') and event.fields.has_key('drilldown_url'):
                  <tr>
                    <td><%self:event_link job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                  % if event.fields.has_key('orig_raw'):
                  <tr>
                    <td><%self:event_orig_raw job="${job}" event="${event}" request="${request}" options="${options}" /></td>
                  </tr>
                  % endif
                </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
      <table style="table-layout: auto; padding-top: 10px; width: 100%;">
        <tbody>
          <tr>
            <td><%self:event_audit job="${job}" event="${event}" request="${request}" options="${options}" /></td>
            <td style="padding-left: 10px;"><%self:event_fields job="${job}" event="${event}" request="${request}" options="${options}" /></td>
          </tr>
        </tbody>
      </table>
    </div>

</%def>\
\
#####################
## Event Select
#####################
<%def name="event_select(job, event, request, options)">
    
    <input type="checkbox"
        % if not is_job_running(job):
        name="ruleuid_field" 
        % endif
        value="${get_field_value(event, 'rule_id')|h}" 
        id="${get_field_value(event, 'rule_id')|h}" 
        % if is_job_running(job):
        disabled="disabled"	
        % endif
        s:status="${get_field_value(event, 'status')|h}" />
        
</%def>\
\
#####################
## Event Actions
#####################
<%def name="event_actions(job, event, request, options)">
    % if not is_job_running(job):
        ${parent.event_actions(job, event, request, options)}
    % else:
    	<a href="#" onclick="alert('The search is still running. Please finalize it first in order to display the workflow actions.'); return false;" class="noactions splIcon splIcon-triangle-large"></a>
    % endif
</%def>\
\
#####################
## Event Time
#####################
<%def name="event_time(job, event, request, options)">
    ${parent.event_time(job, event, request, options)}
</%def>\
\
#####################
## Event Fields
#####################
<%def name="event_fields(job, event, request, options)">
    <ul class="fields">
      <% field_list_items = [x for x in request['field_list'] if event.fields.has_key(x) and x[0]!='_'] %>
      % for field_list_item_index, field_list_item in enumerate(field_list_items):
        % for field_index, field in enumerate(event.fields[field_list_item]):
        <li>
          <%self:event_field_value_pair field="${field}" name="${field_list_item}" value="${field}" is_highlighted="${field.isHighlighted}" tags="${field.tags}", enable_field_actions="${options.get('enable_field_actions', False)}"/>
          % if field_list_item_index+1!=len(field_list_items) or field_index+1!=len(event.fields[field_list_item]):
            |&nbsp;&nbsp;
          % endif
        </li>
        % endfor
      % endfor
    </ul>
</%def>\
#####################
## Event Field Value Pair
#####################
<%def name="event_field_value_pair(field, name, value, is_highlighted, tags, enable_field_actions)">
    ${parent.event_field_value_pair(field, name, value, is_highlighted, tags, enable_field_actions)}
</%def>\
\
#####################
## Event Field Value Pair Tags
#####################
<%def name="event_field_value_pair_tags(tags)">
    ${parent.event_field_value_pair_tags(tags)}
</%def>\
\
#####################
## Event Description
#####################
<%def name="event_description(job, event, request, options)">
    
    <% rule_description = perform_substitution(event, get_field_value(event, 'rule_description')) %>
    
    <table class="rule_description">
      <tbody>
        <tr>
          <td class="header">Description:</td>
        </tr>
        <tr>
          <td>${rule_description|h}</td>
        </tr>
      </tbody>
    </table>
       
</%def>\
\
#####################
## Event Compliance
#####################
<%def name="event_compliance(job, event, request, options)">
    
    <table class="compliance">
      <tbody>
        <tr>
          <td class="header">Compliance:</td>
        </tr>
        <tr>
          <td>
            <table class="compliance_items" cellspacing="0">
              <tbody>
                <tr>
                  <td class="header col1">Governance</td>
                  <td class="header col2">Control</td>
                </tr>
                % for field_index, field in enumerate(event.fields['governance']):
                  <% 
                    governance = get_field_value(event, 'governance', field_index) 
                    control = get_field_value(event, 'control', field_index)
                  %>
                  <tr>
                    <td class="col1">
                      <span class="fields">
                        <em style="display: none;" class="k">governance</em>
                        <em class="v">${governance|h}</em>&nbsp;<a href="#" class="fm">Options</a>
                      </span>
                    </td>
                    <td class="col2">
                      <span class="fields">
                        <em style="display: none;" class="k">control</em>
                        <em class="v">${control|h}</em>&nbsp;<a href="#" class="fm">Options</a>
                      </span>
                    </td>
                  </tr>
                % endfor
              </tbody>
            </table>
          </td>
        </tr>
      </tbody>
    </table>
    
</%def>\
\
#####################
## Event Fields List
#####################
<%def name="event_additional_fields(job, event, request, options, xslt)">
    
    <%
      def get_random_id():
          import random
          return int(random.random() * 1000000000)
          
      rand_id = get_random_id()
              
      # The following dictionary defines the fields that will be shown in the daily log review list
      field_inclusion_list = {
          'action'                    : 'Action',
          'app'                       : 'Application',
          'bytes_in'                  : 'Bytes In',
          'bytes_out'                 : 'Bytes Out',
          'category'                  : 'Category',
          'change_type'               : 'Change Type',
          'channel'                   : 'Channel',
          'command'                   : 'Command',
          'cpu_load_percent'          : 'CPU Load (%)',
          'cve'                       : 'CVE',
          'decoration'                : 'Decoration',
          'desc'                      : 'Description',
          'dest'                      : 'Destination',
          'dest_threatlist_category'   : 'Destination Threat List Category',
          'dest_threatlist_description': 'Destination Threat List Description',
          'dest_threatlist_name'       : 'Destination Threat List Name',
          'dest_bunit'                : 'Destination Business Unit',
          'dest_category'             : 'Destination Category',
          'dest_city'                 : 'Destination City',
          'dest_country'              : 'Destination Country',
          'dest_dns'                  : 'Destination DNS',
          'dest_ip'                   : 'Destination IP Address',
          'dest_is_expected'          : 'Destination Expected',
          'dest_lat'                  : 'Destination Latitude',
          'dest_long'                 : 'Destination Longitude',
          'dest_mac'                  : 'Destination MAC Address',
          'dest_nt_domain'            : 'Destination NT Domain',
          'dest_nt_host'              : 'Destination NT Hostname',
          'dest_owner'                : 'Destination Owner',
          'dest_pci_domain'           : 'Destination PCI Domain',
          'dest_port'                 : 'Destination Port',
          'dest_record'               : 'Destination Record',
          'dest_risk_score'           : 'Dest Risk Score',
          'dest_should_timesync'      : 'Destination Should Time Synchronize',
          'dest_should_update'        : 'Destination Should Update',
          'dest_requires_av'          : 'Destination Requires Antivirus',
          'dest_translated_ip'        : 'Destination Translated IP Address',
          'dest_translated_port'      : 'Destination Translated Port',
          'dest_zone'                 : 'Destination Zone',
          'dhcp_pool'                 : 'DHCP Pool',
          'direction'                 : 'Direction',
          'dns'                       : 'DNS',
          'duration'                  : 'Duration',
          'dvc'                       : 'Device',
          'dvc_bunit'                 : 'Device Business Unit',
          'dvc_category'              : 'Device Category',
          'dvc_city'                  : 'Device City',
          'dvc_country'               : 'Device Country',
          'dvc_dns'                   : 'Device DNS',
          'dvc_ip'                    : 'Device IP Address',
          'dvc_is_expected'           : 'Device Expected',
          'dvc_lat'                   : 'Device Latitude',
          'dvc_long'                  : 'Device Longitude',
          'dvc_mac'                   : 'Device MAC Address',
          'dvc_nt_host'               : 'Device NT Hostname',
          'dvc_owner'                 : 'Device Owner',
          'dvc_pci_domain'            : 'Device PCI Domain',
          'dvc_should_timesync'       : 'Device Should Time Synchronize',
          'dvc_should_update'         : 'Device Should Update',
          'dvc_requires_av'           : 'Device Requires Antivirus',
          'end_time'                  : 'End Time',
          'file_access_time'          : 'File Access Time',
          'file_create_time'          : 'File Creation Time',
          'file_hash'                 : 'File Hash',
          'file_modify_time'          : 'File Modify Time',
          'file_name'                 : 'File Name',
          'file_path'                 : 'File Path',
          'file_permission'           : 'File Permission',
          'file_size'                 : 'File Size',
          'FreeMBytes'                : 'Free Megabytes',
          'gap'                       : 'Gap',
          'gid'                       : 'GID',
          'hash'                      : 'Hash',
          'http_content_type'         : 'HTTP Content Type',
          'http_method'               : 'HTTP Method',
          'http_referrer'             : 'HTTP Referrer',
          'http_user_agent'           : 'HTTP User Agent',
          'ids_type'                  : 'Intrusion Detection Type',
          'iin_issuer'                : 'Issuer Identification Number (IIN)',
          'ip'                        : 'IP Address',
          'ip_version'                : 'Internet Protocol Version',
          'is_interactive'            : 'Interactive',
          'is_lockout'                : 'Is Lockout',
          'is_privileged'             : 'Is Privileged',
          'isdir'                     : 'Is Directory',
          'length'                    : 'Length',
          'location'                  : 'Location',
          'log_level'                 : 'Log Level',
          'mac'                       : 'MAC Address',
          'mem'                       : 'Total Memory',
          'mem_committed'             : 'Committed Memory',
          'mem_free'                  : 'Free Memory',
          'mem_used'                  : 'Used Memory',
          'mode'                      : 'Mode',
          'modtime'                   : 'Modification Time',
          'mount'                     : 'Mount',
          'name'                      : 'Name',
          'note'                      : 'Note',
          'nt_host'                   : 'NT Hostname',
          'object_handle'             : 'Object Handle',
          'object_name'               : 'Object Name',
          'object_type'               : 'Object Type',
          'orig_host'                 : 'Host',
          'orig_host_bunit'           : 'Host Business Unit',
          'orig_host_category'        : 'Host Category',
          'orig_host_city'            : 'Host City',
          'orig_host_country'         : 'Host Country',
          'orig_host_dns'             : 'Host DNS',
          'orig_host_ip'              : 'Host IP Address',
          'orig_host_is_expected'     : 'Host Expected',
          'orig_host_lat'             : 'Host Latitude',
          'orig_host_long'            : 'Host Longitude',
          'orig_host_mac'             : 'Host MAC Address',
          'orig_host_nt_host'         : 'Host NT Hostname',
          'orig_host_owner'           : 'Host Owner',
          'orig_host_pci_domain'      : 'Host PCI Domain',
          'orig_host_should_timesync' : 'Host Should Time Synchronize',
          'orig_host_should_update'   : 'Host Should Update',
          'orig_host_requires_av'     : 'Host Requires Av',
          'os'                        : 'Operating System',
          'os_name'                   : 'Operating System Name',
          'os_release'                : 'Operating System Release',
          'outbound_interface'        : 'Outbound Interface',
          'package'                   : 'Package',
          'package_title'             : 'Package Title',
          'packets_in'                : 'Packets In',
          'packets_out'               : 'Packets Out',
          'path'                      : 'Path',
          'PercentFreeSpace'          : 'Free Space (%)',
          'PercentProcessorTime'      : 'Processor Time (%)',
          'pid'                       : 'Process Identifier',
          'pii'                       : 'Personally Identifiable Information (PII)',
          'port'                      : 'Port',
          'process'                   : 'Process',
          'product'                   : 'Product',
          'product_version'           : 'Product Version',
          'proto'                     : 'Internet Protocol',
          'reason'                    : 'Reason',
          'recipient'                 : 'Recipient',
          'record_class'              : 'Record Class',
          'record_type'               : 'Record Type',
          'result'                    : 'Result',
          'rule_number'               : 'Rule Identifier',
          'selinux'                   : 'SELinux',
          'selinuxtype'               : 'SELinux Type',
          'sender'                    : 'Sender',
          'session_id'                : 'Session Identifier',
          'setlocaldefs'              : 'Set Local Definitions',
          'severity_id'               : 'Severity Identifier ',
          'signature'                 : 'Signature',
          'signature_id'              : 'Signature Identifier',
          'signature_version'         : 'Signature Version',
          'size'                      : 'Size',
          'src'                       : 'Source',
          'src_threatlist_category'    : 'Source Threat List Category',
          'src_threatlist_description' : 'Source Threat List Description',
          'src_threatlist_name'        : 'Source Threat List Name',
          'src_bunit'                 : 'Source Business Unit',
          'src_category'              : 'Source Category',
          'src_city'                  : 'Source City',
          'src_country'               : 'Source Country',
          'src_dns'                   : 'Source DNS',
          'src_ip'                    : 'Source IP Address',
          'src_is_expected'           : 'Source Expected',
          'src_lat'                   : 'Source Latitude',
          'src_long'                  : 'Source Longitude',
          'src_mac'                   : 'Source MAC Address',
          'src_nt_domain'             : 'Source NT Domain',
          'src_nt_host'               : 'Source NT Hostname',
          'src_owner'                 : 'Source Owner',
          'src_pci_domain'            : 'Source PCI Domain',
          'src_port'                  : 'Source Port',
          'src_record'                : 'Source Record',
          'src_should_timesync'       : 'Source Should Time Synchronize',
          'src_should_update'         : 'Source Should Update',
          'src_requires_av'           : 'Source Requires Antivirus',
          'src_risk_score'            : 'Source Risk Score',
          'src_translated_ip'         : 'Source Translated IP Address',
          'src_translated_port'       : 'Source Translated Port',
          'src_user'                  : 'Source User',
          'src_user_group'            : 'Source User Group',
          'src_user_group_id'         : 'Source User Group Identifier',
          'src_user_id'               : 'Source User Identifier',
          'src_user_privilege'        : 'Source User Privilege',
          'src_zone'                  : 'Source Zone',
          'sshd_protocol'             : 'SSHD Protocol',
          'ssid'                      : 'Service Set Identifier (SSID)',
          'storage'                   : 'Total Storage',
          'storage_free'              : 'Free Storage',
          'storage_free_percent'      : 'Free Storage (%)',
          'storage_used'              : 'Used Storage',
          'storage_used_percent'      : 'Used Storage (%)',
          'start_mode'                : 'Start Mode',
          'start_time'                : 'Start Time',
          'StartMode'                 : 'Start Mode',
          'subject'                   : 'Subject',
          'syslog_facility'           : 'Syslog Facility',
          'syslog_priority'           : 'Syslog Priority',
          'SystemUpTime'              : 'System Uptime',
          'tcp_flags'                 : 'TCP Flags',
          'threat'                    : 'Threat',
          'threat_ip'                 : 'Threat IP',
          'tos'                       : 'Type Of Service',
          'TotalMBytes'               : 'Total Megabytes',
          'transaction_id'            : 'Transaction Identifier',
          'transport'                 : 'Transport Protocol',
          'ttl'                       : 'Time To Live',
          'uid'                       : 'UID',
          'uptime'                    : 'Uptime',
          'url'                       : 'URL',
          'url_risk_score'            : 'URL Risk Score',
          'UsedMBytes'                : 'Used Megabytes',
          'user'                      : 'User',
          'user_group'                : 'User Group',
          'user_group_id'             : 'User Group Identifier',
          'user_id'                   : 'User Identifier',
          'user_privilege'            : 'User Privilege',
          'validity'                  : 'Validity',
          'vendor'                    : 'Vendor',
          'vendor_product'            : 'Vendor/Product',
          'view'                      : 'View',
          'vlan_id'                   : 'VLAN Identifier',
          'vlan_name'                 : 'VLAN Name'
      }
    %>
    
    <table class="additional_fields">
      <tbody>
        <tr>
          <td class="header">Additional Fields:</td>
        </tr>  
        % for field_list_item_index, field_list_item in enumerate(event.fields):
          % if field_inclusion_list.has_key(field_list_item):
          <tr>
            <% nice_name = field_inclusion_list[field_list_item] %>
            <td>
            % if field_list_item == "iin_issuer":
              <% 
                value = get_field_value(event, field_list_item)
                issuer_css_class = value.lower().replace(" ", "_")
              %>
              <span class="fields credit_card ${issuer_css_class|h}">
                <em style="display: none;" class="k">${field_list_item|h}</em>${nice_name|h}: <em class="v">${value|h}</em>&nbsp;<a href="#" class="fm">Options</a>
              </span>
            % else:
              <span class="fields">
                <em style="display: none;" class="k">${field_list_item|h}</em>
                  ${nice_name|h}: \
                % for field_index, field in enumerate(event.fields[field_list_item]):
                  <% value = get_field_value(event, field_list_item, field_index) %>
                  <em class="v">${value|h}</em>&nbsp;<%self:event_field_value_pair_tags tags="${field.tags}"/>&nbsp;<a href="#" class="fm">Options</a>
                % endfor
              </span>
            % endif
            </td>      
          </tr>
          % endif
        % endfor
      </tbody>
    </table>
    
</%def>\
\
#####################
## Event Source
#####################
<%def name="event_source(job, event, request, options)">

    <% source = get_field_value(event, 'source') %>                
    
    <table class="source">
      <tbody>
        <tr>
          <td class="header">Correlation Search:</td>
        </tr>
        <tr>
          <td>
             % if source != 'Manual Notable Event - Rule':
             <a href="${make_url(['app', request['client_app'], 'correlation_search_edit'], _qs=dict(name=source))}" target="_blank">${source|h}</a>
             % else:
             None (manually created)
             % endif
          </td>
        </tr>
      </tbody>
    </table>
    
</%def>\
\
#####################
## Event Link
#####################
<%def name="event_link(job, event, request, options)">

    <%
      drilldown_name = perform_substitution(event, get_field_value(event, 'drilldown_name'))
      drilldown_url = perform_substitution(event, get_field_value(event, 'drilldown_url'), True)
    %>
    
    <table class="drilldown">
      <tbody>
        <tr>
          <td class="header">More details:</td>
        </tr>
        <tr>
          <td>
          % if drilldown_url.startswith("http://") or drilldown_url.startswith("https://"):
            <a href="${drilldown_url}" target="_blank">${drilldown_name|h}</a>
          % else:
            <a href="${drilldown_url}" target="_blank">${drilldown_name|h}</a>
          % endif
          </td>
        </tr>
      </tbody>
    </table>
    
</%def>\
\
#####################
## Event Drilldown
#####################
<%def name="event_drilldown(job, event, request, options)">

    <%
      drilldown_name = perform_substitution(event, get_field_value(event, 'drilldown_name'))
      drilldown_search = perform_substitution(event, get_field_value(event, 'drilldown_search'), True)
      drilldown_search = drilldown_search.replace('"', '\"')
      
      if not drilldown_search.startswith('|'):
          drilldown_search = 'search ' + drilldown_search
    %>
    
    <table class="drilldown">
      <tbody>
        <tr>
          <td class="header">Contributing Events:</td>
        </tr>
        <tr>
          <td>  
            <a href="${make_url(['app',request['client_app'],'flashtimeline'], _qs=dict(q=drilldown_search))}" target="_blank">${drilldown_name|h}</a>
          </td>
        </tr>
      </tbody>
    </table>
    
</%def>\
\
#####################
## Event Orig Raw
#####################
<%def name="event_orig_raw(job, event, request, options)">

    <%
      import re
     
      ## Check for ugly _raw events
      ## A.  single line > 600 chars
      ## B.  non-whitespace sequence >= 55 chars   
      def is_raw_nasty(raw):
          newlineRE = re.compile('([\r\n]+)')
          newlineMatch = newlineRE.findall(raw)
          
          nastyRE = re.compile('([^\s]{55})')
          nastyMatch = nastyRE.search(raw)
          
          if len(newlineMatch) <= 1 and len(raw) > 600:
              return True
          
          elif nastyMatch:
              return True
          
          else:              
              return False  
      
      ## Build drilldown search    
      if event.fields.has_key('orig_event_hash') or event.fields.has_key('orig_cd'):          
          if event.fields.has_key('orig_event_hash'):
              orig_search = ' | `get_event_hash` | search event_hash=' + get_field_value(event, 'orig_event_hash')
            
          if event.fields.has_key('orig_cd'):
              orig_search = ' | search _cd=' + get_field_value(event, 'orig_cd')
  
          if event.fields.has_key('orig_index'):
              orig_search = 'index=' + get_field_value(event, 'orig_index') + ' ' + orig_search
          
          if event.fields.has_key('orig_splunk_server'):
              orig_search = 'splunk_server=' + get_field_value(event, 'orig_splunk_server') + ' ' + orig_search
            
          if event.fields.has_key('orig_time'):
            orig_search = '_time=' + get_field_value(event, 'orig_time') + ' ' + orig_search
            
          orig_search = orig_search + ' | head 1'
          
      orig_raw = get_field_value(event, 'orig_raw')
    %>
    
    <% 
    raw_is_nasty = is_raw_nasty(orig_raw)
    %>
    % if event.fields.has_key('orig_event_hash') or event.fields.has_key('orig_cd') or not raw_is_nasty: 
    <table class="orig_raw">
      <tbody>
        <tr>
          <td class="header">Original Event:</td>
        </tr>
        % if not raw_is_nasty:
        <tr>
          <td>
            <% value = orig_raw %>\
            <% lines = value.split('\n') %>\
            <pre class="event">\
              % for line in range(0, min(10,len(lines))):
                % if line == 9 or line == len(lines)-1:
${lines[line]|h}\
                % else:
${lines[line]|h}<br />\
                % endif
              % endfor
            </pre>
            <% import random %>\
            <% id = int(random.random()*100000) %>\
            % if len(lines) > 10:
              <pre style="display: none;" id=${id} class="event">
                % for line in range(10, len(lines)):
${lines[line]|h}<br />\
                % endfor
              </pre>
              <a href="#" onclick="$('#${id}').toggle();$('#show_${id}').toggle();$('#hide_${id}').toggle();return false;">
                  <span id="show_${id}">Show all ${len(lines)} lines</span>
                  <span style="display: none;" id="hide_${id}">Collapse back to 10 lines</span>
              </a> 
            % endif
          </td>
        </tr>
        % endif
        % if event.fields.has_key('orig_event_hash') or event.fields.has_key('orig_cd'):          
        <tr>
          <td><a href="${make_url(['app',request['client_app'],'flashtimeline'], _qs=dict(q='search ' + orig_search))}" target="_blank">View original event</a></td>
        </tr>
        % endif
      </tbody>
    </table>
    % endif
    
</%def>\
\ 
#####################
## Event Audit
#####################
<%def name="event_audit(job, event, request, options)">
    ${parent.event_audit(job, event, request, options)}
</%def>\
\
#####################
## Event Edit History
#####################
<%def name="event_edit_history(job, event, request, options)">

    <%
      rule_id = get_field_value(event, 'rule_id')
      rule_title = perform_substitution(event, get_field_value(event, 'rule_title'))
    %>
    
    <table class="history">
      <tbody>
        <tr>
          <td class="header">History:</td>
        </tr>
        % if event.fields.has_key('last_comment'):
        <% 
        	last_comment = get_field_value(event, 'last_comment')
        	review_time = get_field_value(event, 'review_time')
        	reviewer = get_field_value(event, 'reviewer_realname')
        %>
        <tr>
          <td style="padding-top: 5px; padding-bottom: 5px; font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif; font-size: 11px;">
            <div style="padding: 5px; border: 1px solid #CCCCCC;">
          	  <div style="float: right;">${reviewer|h}</div>
          	  <div style="padding-bottom: 10px;">${review_time|h}</div>
          	  ${last_comment|h}
            </div>
          </td>
        </tr>
        % endif
        <tr>
          <td>  
            <a href="${make_url(['app',request['client_app'],'flashtimeline'], _qs=dict(q='| `incident_review` | search rule_id="' + rule_id + '" | rename status_label as status | fields _time, rule_id, reviewer, urgency, status, owner, comment'))}" target="_blank">View all review activity for this Notable Event</a>
          </td>
        </tr>
      </tbody>
    </table>
    
</%def>\
