<%
## Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

import logging
import sys
import os
import splunk

sys.path.append( os.path.join("..", "..", "..", "bin") )

from NotableEventStatusEditor import is_role_enabled, escape_message,  get_transition_label, get_transition_roles, none_to_blank, get_option_name, get_id, TRANSITION_ENABLED, TRANSITION_DISABLED, TRANSITION_IMPORTED, get_role_status, output_if_true
from notable_event_status import NotableEventStatus, StatusTransition, create_transition_str

logger = logging.getLogger('splunk.appserver.SA-ThreatIntelligence.modules.NotableEventStatusEdit')

## Get cherry key
session_key = cherrypy.session.get('sessionKey')

## Get cherry username
user = cherrypy.session['user']['name']

## Get capabilities
capabilities = NotableEventStatus.getCapabilities4User(user, session_key)

## Test capabilities
insufficient_permissions = True

if 'edit_reviewstatuses' in capabilities:
    insufficient_permissions = False

## Get args
args = cherrypy.serving.request.params

messages = []

# Below are the variables we will try to populate
notable_statuses = None
enabled_transitions = None
transition_map = None

try:

	# Get the status
	if 'id' in args and len(args['id']) > 0:
	    notable_status = NotableEventStatus.get_notable_status( args['id'] )
	else:
		notable_status = NotableEventStatus(None, "", "", True, False)
	
	# Get the URL to redirect to
	redirect = None
	
	# Get the form action URL
	form_action = make_url(["module", "system", "Splunk.Module.NotableEventStatusEditor", "render"]);
	
	# Get the app name
	app = APP['id']
	
	# Get the list of status transitions
	notable_statuses = NotableEventStatus.get_notable_statuses( enabled_statuses_only=True )
	
	# Get the roles
	roles = StatusTransition.__get_roles__()
	
	# Get the transition map
	if notable_status.id is not None:
		transition_map = StatusTransition.get_transition_map(id=notable_status.id, include_imported_capabilities=True, force_reload=True)
	else:
		transition_map = None
		
	# Get the list of enabled transitions
	enabled_transitions = StatusTransition.get_enabled_transitions()
  
    ## Set html input as enabled/disabled
	if notable_status.id == '0':
		htmlInputDisabled = True
	else:
		htmlInputDisabled = False
  
except splunk.AuthorizationFailed:
	insufficient_permissions = True
	
# Determine the correct link to the auth system
version_info = splunk.version.__version__.split(".")

if len(version_info) >= 2 and (int(version_info[0]) > 4 or (int(version_info[0]) >= 4 and int(version_info[1]) >= 3)):
	auth_roles_link = "authorization/roles"
else:
	auth_roles_link = "authentication/roles"
	
%>

<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine-en.js'])}" type="text/javascript" charset="utf-8"></script>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine.js'])}" type="text/javascript" charset="utf-8"></script>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/ui.dropdownchecklist-1.4-min.js'])}" type="text/javascript" ></script>

<script type="text/javascript">
	$(document).ready(function() {
		$("#eaiform").validationEngine();
		$('#transitions_table').fadeTo( 10, 1);
	});
</script>

<style>
    @import url("${make_url(['/static/css/admin.css'])}");
    @import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/validationEngine.jquery.css'])}" );
    @import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/ui.dropdownchecklist.standalone.css'])}" );
    
    .Message {
        padding: 0;
    }
       
    input[disabled] {
        padding-left: 7px;
    }
    
    #es_no_permissions div.adminGroup {
      border: none;
      box-shadow: none;
      padding: 0px;
    }
    
    #es_no_permissions div.adminListItem {
      border-bottom: none;
      min-height: 45px;
      padding-left: 15px;
    }
    
    #es_no_permissions dd {
      border-left: none;
      padding-top: 16px;
    }
</style>

% if not insufficient_permissions:
  <form autocomplete="off" enctype="multipart/form-data" action="${form_action}" method="get" class="entityEditForm statusEditor" id="eaiform">
  
  % if notable_status is not None and notable_status.id is not None and len(notable_status.id) > 0:
  	<input type="hidden" value="${notable_status.id | h}" name="id" />
  	<fieldset><legend style="padding: 0px 0px 0px 10px;">Edit Notable Event Status</legend></fieldset>
  % else:
  	<fieldset><legend style="padding: 0px 0px 0px 10px;">New Notable Event Status</legend></fieldset>
  % endif
          
  % if redirect is not None:
  	<input type="hidden" value="${redirect | h}" name="__redirect" />
  % endif
	
	<div id="item-basicgroup" class="fieldsetWrapper">
    	<fieldset id="">

		## ---------------------------
    	## Label
		## ---------------------------
            <div class="" id="label">
            	<label class="">Label</label>
    			<div>
					<div class="widgeterror"></div>
					<input type="text" ${output_if_true('disabled="True"', htmlInputDisabled)} value="${notable_status.name | h}" id="form_label" name="name" class="validate[required,custom[validStanza]]" />
					%if htmlInputDisabled:
					<input type="hidden" value="${notable_status.name | h}" name="name" />
					% endif
       			</div>
    		</div>
    		
		## ---------------------------
    	## Description
		## ---------------------------
			<div class="" id="label">
				<label class="">Description</label>
				<div>
            		<div class="widgeterror"></div>
            		<textarea name="description" ${output_if_true('disabled="True"', htmlInputDisabled)} class="regular " rows="5" cols="45">${none_to_blank(notable_status.description) | h}</textarea>
            	</div>
            </div>
            
		## ---------------------------
    	## Default status
		## ---------------------------
			<div class="checkboxWidget " id="item-is_default">
			    <div>
			        <div class="widgeterror"></div>
			        <input ${output_if_true('disabled="True"', htmlInputDisabled)} type="checkbox" value="1" id="checkbox-is_default" name="is_default" class="checkbox proxiable" ${output_if_true('checked="True"', notable_status.is_default)} />
			        <label for="checkbox-is_default" class="">Default status</label>
			    </div>
			</div>
			
		## ---------------------------
    	## End status
		## ---------------------------
			<div ${output_if_true('style="display:none"', notable_status.is_default)} class="checkboxWidget " id="item-is_end">
			    <div>
			        <div class="widgeterror"></div>
			        <input ${output_if_true('disabled="True"', htmlInputDisabled)} type="checkbox" value="1" id="checkbox-is_end" name="end" class="checkbox proxiable" ${output_if_true('checked="True"', notable_status.end)} />
			        <label for="checkbox-is_end" class="">End status</label>
			    </div>
			</div>
			<div ${output_if_true('style="display:none"', not notable_status.is_default)} class="checkboxWidget " id="item-is_end_placeholder">
				<div>
			        <input disabled="True" type="checkbox" value="0" id="checkbox-is_end_placeholder" name="is_end" class="checkbox proxiable" />
			        <label for="checkbox-is_end_placeholder" class="">End status (default statuses cannot be an end status)</label>
			    </div>
			</div>
			
		## ---------------------------
    	## Enabled/disabled status
		## ---------------------------
			<div ${output_if_true('style="display:none"', notable_status.is_default)} class="checkboxWidget " id="item-is_enabled">
			    <div>
			        <div class="widgeterror"></div>
			        <input ${output_if_true('disabled="True"', htmlInputDisabled)} type="checkbox" value="1" id="checkbox-is_enabled" name="enabled" class="checkbox proxiable" ${output_if_true('checked="True"', notable_status.enabled)} />
			        <label for="checkbox-is_enabled" class="">Enabled</label>
			    </div>
			</div>
			<div ${output_if_true('style="display:none"', not notable_status.is_default)} class="checkboxWidget " id="item-is_enabled_placeholder">
				<div>
			        <input disabled="True" type="checkbox" value="1" id="checkbox-is_enabled_placeholder" name="is_enabled_placeholder" class="checkbox proxiable" checked="True" />
			        <label for="checkbox-is_enabled_placeholder" class="">Enabled (default statuses must be enabled)</label>
			    </div>
			</div>
			
		## ---------------------------
    	## Hidden meta fields
		## ---------------------------
			<input type="hidden" value="${app | h}" name="namespace" />
			## The following is required so that the app knows where to send the user when redirecting after editing the entry
    		<input type="hidden" value="${app | h}" name="app" id="app" />
    		
  		## ---------------------------
    	## Transitions table
		## ---------------------------
		
			<div class="" id="transitions">
				<legend>Status Transitions</legend>
		    		<table style="opacity: 0.01" id="transitions_table" class="splTable">
		    			<tr>
		    				<th id="transitions_status">To Status</th>
		    				<th id="transitions_authorization">Authorization</th>
		    				<th id="transitions_operations"></th>
		    			</tr>
		    		%for status in notable_statuses:
		    			% if status.id != notable_status.id and status.id != '0':
		    			<tr>
		    				<td style="vertical-align: middle;">${status.name | h}</td>
		    				<td>
		    				<select name="transitions_new" style="width: 100%" class="transitions_select" id="combobox_status_${status.id | h}" multiple="true">
		    				%for role in roles:
		    					<%
		    					role_status = get_role_status(transition_map, status, role)
		    					
		    					trans_str = create_transition_str(get_id(notable_status), status, role)
		    					
		    					if role_status == TRANSITION_IMPORTED:
		    						trans_str = "imported_" + trans_str
		    						role_name = role + " (inherited)"
		    					else:
		    						role_name = role
		    					%>
		    					
		    					
		    					<option class="status_${status.id | h}" value="${trans_str | h}"
		    						%if role_status == TRANSITION_ENABLED:
		    							selected="true"
		    						% elif role_status == TRANSITION_IMPORTED:
		    							selected="true" disabled="true"
		    						%endif
		    					>${role_name | h}</option>
							%endfor
							</select>
							</td>
							<td style="vertical-align: middle;">
		    					<a id="status_${status.id | h}_select" href="#">Select All</a> | <a id="status_${status.id | h}_unselect" href="#">Unselect All</a>
			    				<script language="Javascript">
		    					
									##
			    					## Unchecks/checks disabled transitions depending on whether any enabled transitions are selected
			    					## 
									function check_statuses_${status.id | h}( selector ){
									
										var enabled_checked = $('.status_${status.id | h}:selected:not(:disabled)').length;
										if( enabled_checked > 0 ){
										    $('.status_${status.id | h}:disabled').attr('selected','true');
										}
										else{
										    $('.status_${status.id | h}:disabled').removeAttr('selected');
										}
										remake_dropdown_${status.id | h}();
										return enabled_checked;
									}


									##
			    					## Destroys the existing drop-down and re-makes it
			    					## 
									function remake_dropdown_${status.id | h}(){
										$("#combobox_status_${status.id | h}").dropdownchecklist("destroy");
										make_dropdown_${status.id | h}();
									}

									##
			    					## Makes the combo-box into a drop-down
			    					## 
									function make_dropdown_${status.id | h}(){
										$("#combobox_status_${status.id | h}").dropdownchecklist( { icon: {}, emptyText: '<span class="noneSelected">No roles selected</span>', width: 450, onComplete: check_statuses_${status.id | h} } );
									}

									##
			    					## Sets up the select-all handler
			    					## 
				    				
			    					$('#status_${status.id | h}_select').click( function(){
										$('.status_${status.id | h}').attr('selected','true');
										check_statuses_${status.id | h}();
										remake_dropdown_${status.id | h}();
										return false;
			    					} );

									##
			    					## Sets up the unselect-all handler
			    					## 
									
			    					$('#status_${status.id | h}_unselect').click( function(){
				    					
										$('.status_${status.id | h}:not(:disabled)').removeAttr('selected');
										check_statuses_${status.id | h}();
										remake_dropdown_${status.id | h}();
										return false;
			    					} );

									##
			    					## Create the drop-down when ready...
			    					## 
			    					$(document).ready(function() {
			    						make_dropdown_${status.id | h}();
			    					} );
			    					
			    				</script>
		    				</td>
		    			</tr>
		    			% endif
		    		%endfor
		    		</table>
		    		<div class="helpNote">
		    		Transitions that are imported from an inherited role can be removed by disabling the transition for the role that is being inherited.
		    		<!-- Per SOLNESS-1314 conditionally rendering the following statement based on 'edit_roles' capability -->
                    % if 'edit_roles' in capabilities:
                    Alternatively, you can <a target="_blank" href="${make_url(['manager', app, auth_roles_link])}">edit the role in the Splunk manager</a> and remove the inherited role.
		    		% endif
                    </div>
	    	</div>
	    	
  		## ---------------------------
    	## Original options list
		## ---------------------------
	    	%for status in notable_statuses:
		    	%for role in roles:
		    		% if status.id != notable_status.id:
		    <input type="hidden" value="${create_transition_str( get_id(notable_status), status, role) | h}" selected="true" name="transitions_orig" />
		    		% endif
				%endfor
		    %endfor
		    
		    
  		## ---------------------------
    	## Original transitions list
		## ---------------------------
	    	%if enabled_transitions is not None:
	    		%for transition in enabled_transitions:
		    <input type="hidden" value="${transition | h}" selected="true" name="enabled_transitions_orig" />
		    	%endfor
		    %endif 
    	
		</fieldset>
	</div>	
	
	<div class="jmFormActions">
		<button type="button" id="cancel_button" class="splButton-secondary"><span>Cancel</span></button>
        <button class="splButton-primary" type="submit"><span id="save_button">Save</span></button>
    </div>
  </form>
% else:
  <div class="adminContent">
    <div class="adminIndex" id="es_no_permissions">
      <div class="adminGroup">
        <div class="adminListItem">
          <a class="adminListIcon" style="background: url(${make_url(['static','img','skins','default','managerIcons','icon_access.png'])}) no-repeat 0px 0;"></a>
          <dd>You do not have the necessary capabilities required to edit Notable Event Statuses.  Please contact your Splunk administrator.</dd>
        </div>
      </div>
    </div>
  </div>
% endif