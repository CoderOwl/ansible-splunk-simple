<%# Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

import logging
import splunk.entity as entity

import sys
import os
sys.path.append( os.path.join("..", "..", "..", "bin") )

from notable_event_status import NotableEventStatus

logger = logging.getLogger('splunk.appserver.SA-ThreatIntelligence.modules.NotableEventStatusList')

## Get cherry key
session_key = cherrypy.session.get('sessionKey')

## Get cherry username
user = cherrypy.session['user']['name']

## Get capabilities
capabilities = NotableEventStatus.getCapabilities4User(user, session_key)

## Test capabilities
insufficient_permissions = True

if 'edit_reviewstatuses' in capabilities:
    insufficient_permissions = False

args = cherrypy.serving.request.params

def escape_message( msg ):
	return msg.replace("'", "").replace('"', "")

messages = []

# Disable the given item
if 'disable' in args:

	try:
		NotableEventStatus.disable( args['disable'] )
		messages.append( {'severity' : 'info', 'message' : 'Status successfully disabled'} )
	except Exception as e:
	
		# Return a message noting that operation failed because the user does not have permission
		if str(e).find("AuthorizationFailed") >= 0:
			messages.append( {'severity' : 'error', 'message' : 'You do not have permission to modify notable event statuses'} )
		else:
			messages.append( {'severity' : 'error', 'message' : 'Error occurred while disabling the status: ' + str(e)} )
	
	
# Enable the given item
if 'enable' in args:

	try:
		NotableEventStatus.enable( args['enable'] )
		messages.append( {'severity' : 'info', 'message' : 'Status successfully enabled'} )
	except Exception as e:
	
		# Return a message noting that operation failed because the user does not have permission
		if str(e).find("AuthorizationFailed") >= 0:
			messages.append( {'severity' : 'error', 'message' : 'You do not have permission to modify notable event statuses'} )
		else:
			messages.append( {'severity' : 'error', 'message' : 'Error occurred while enabling the status: ' + str(e)} )
		
		
# Set the given item as the default
if 'default' in args:

	try:
		NotableEventStatus.set_default( args['default'] )
		messages.append( {'severity' : 'info', 'message' : 'Status successfully set as the default'} )
	except Exception as e:
		messages.append( {'severity' : 'error', 'message' : 'Error occurred while setting the status as the default: ' + str(e)} )

# List the statuses
notable_statuses = NotableEventStatus.get_notable_statuses()

# Get the app name
app = APP['id']
%>
<%page args="module"/>
<div class="adminContent">
	
	<script language="javascript">

	var messenger = Splunk.Messenger.System.getInstance();

	% for message in messages:
	messenger.send("${message['severity']}", "splunk.sa_threatintelligence", "${escape_message(message['message'])}");
	% endfor
	
	</script>
	
	<div class="adminContentList">
		
		## ---------------------------
		## Page header
		## ---------------------------		
		<div class="eaiPagination">
			<div class="eaiPaginationHeader splClearfix">
				<h2 class="title">Notable Event Statuses</h2>
				
				<div class="actionButtons">
					<a target="_parent" href="${make_url(['app', app, module['view_new']])}" class="splButton-primary">
						<span>New</span>
					</a>
			    </div>
			</div>
		            
			<div></div>
		</div>
		
		
		## ---------------------------
		## Table header
		## ---------------------------
		<div class="listWrapper">
		<table class="notable_status_list splTable">
			<tr>
				<th class="header_label">
					Label
				</th>      
				<th class="description_label">
					Description
				</th>
				<th class="status_label">
					Status
				</th>
			</tr>
		
		## ---------------------------
		## Search list
		## ---------------------------
		% for notable_status in notable_statuses:
			<tr>
				<td class="long_text_cell"><a href="${make_url(['app', app, module['view_edit']])}?id=${notable_status.id}">${notable_status.name | h}</a>
				% if notable_status.is_default:
					<strong>(default)</strong>
				% endif
				</td>
			% if notable_status.description is not None:
				<td class="long_text_cell">${notable_status.description | h}</td>
			% else:
				<td>NA</td>
			% endif
				<td>
            % if notable_status.id != '0':
    			% if notable_status.enabled:
                    % if not insufficient_permissions:
            			% if notable_status.is_default:
            				Enabled
            			% else:
            				Enable | <a href="?disable=${notable_status.id}">Disable</a>
            			% endif
                    % else:
                      Enabled
                    % endif
    			% else:
                    % if not insufficient_permissions:
            			% if notable_status.is_default:
            				## should never get here
            				Disabled
            			% else:
            				Disable | <a href="?enable=${notable_status.id}">Enable</a>
            			% endif
                    % else:
                      Disabled
                    % endif
    			% endif
            % else:
              Enabled
            % endif
				</td>
			</tr>
		% endfor
		
		</table>
		</div>
	     
	</div>
</div>
