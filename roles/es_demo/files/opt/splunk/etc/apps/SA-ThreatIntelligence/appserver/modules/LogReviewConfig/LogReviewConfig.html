<%
# Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

args = cherrypy.serving.request.params

# Get the form action URL
form_action = make_url(["module", "system", "Splunk.Module.LogReviewConfig", "render"]);

# Get the user name
user = cherrypy.session['user']['name']

## Get cherry key
session_key = cherrypy.session.get('sessionKey')
	
# Get the app name
app = APP['id']

from LogReviewConfig import LogReviewConfig, output_if_true, str_to_bool

# Determine if the user has permission to edit the log review settings
if LogReviewConfig.canEdit(user, session_key):
	insufficient_permissions = False
else:
	insufficient_permissions = True

if insufficient_permissions == False:
	comment_en = LogReviewConfig.getCommentEntity()
	
	comment_minimum_length = comment_en['minimum_length']
	
	try:
		comment_minimum_length = int(comment_minimum_length)
	except:
		pass
	
	comment_is_required = str_to_bool(comment_en['is_required'])
	
	allow_urgency_override = LogReviewConfig.isUrgencyOverrideAllowed()
	
else:
	comment_minimum_length = 0
	comment_is_required = False
	allow_urgency_override = True

%>

<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine-en.js'])}" type="text/javascript" charset="utf-8"></script>
<script src="${make_url(['/static/app/SA-ThreatIntelligence/scripts/jquery.validationEngine.js'])}" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $("#eaiform").validationEngine();
    });
</script>

<style>
    @import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/validationEngine.jquery.css'])}" );
    @import url("${make_url(['/static/app/SA-ThreatIntelligence/stylesheets/ui.dropdownchecklist.standalone.css'])}" );
</style>

% if not insufficient_permissions:
  <form autocomplete="off" enctype="multipart/form-data" action="${form_action}" method="get" class="logReviewEditForm" id="eaiform">
    <fieldset><legend>Incident Review Settings</legend></fieldset>
    	
  	<div id="item-basicgroup" class="fieldsetWrapper">
    		
		## ---------------------------
    	## Urgency override is allowed
		## ---------------------------
			<div class="checkboxWidget " id="item-allow_urgency_override">
			    <div>
			        <div class="widgeterror"></div>
			        <input ${output_if_true(allow_urgency_override, "checked")} type="checkbox" value="1" id="checkbox-allow_urgency_override" name="allow_urgency_override" class="checkbox proxiable" />
			        <label for="checkbox-allow_urgency_override" class="">Allow Overriding of Urgency</label>
			    </div>
			</div>
			
		## ---------------------------
    	## Comment is required
		## ---------------------------
			<div class="checkboxWidget " id="item-is_required">
			    <div>
			        <div class="widgeterror"></div>
			        <input ${output_if_true(comment_is_required, "checked")} type="checkbox" value="1" id="checkbox-is_required" name="is_required" class="checkbox proxiable" />
			        <label for="checkbox-is_required" class="">Comment Required</label>
			    </div>
			</div>
  	
		## ---------------------------
    	## Minimum Length Required
		## ---------------------------
            <div ${output_if_true(comment_minimum_length > 0 and not comment_is_required, 'style="display:none"')} id="minimum_comment_length">
            	<label class="">Minimum Length Required:</label>
    			<div>
					<div class="widgeterror"></div>
					<input type="text" value="${comment_minimum_length | h}" id="form_minimum_comment_length" name="minimum_comment_length" class="validate[required,custom[integer],min[1],max[1024]]" />
       			</div>
    		</div>
    		
    		<p class="exampleText"><em>Making comments required will prevent users from editing events in the Incident Review page unless a comment is provided.</em></p>
    		
		## ---------------------------
    	## Finally, the form actions
		## ---------------------------
 			<div class="jmFormActions">
        		<button class="splButton-primary" type="submit"><span id="save_button">Save</span></button>
    		</div>
    		
	</div>
  </form>
% else:
  <div class="adminContent">
    <div class="adminIndex" id="es_no_permissions">
      <div class="adminGroup">
        <div class="adminListItem">
          <a class="adminListIcon" style="background: url(${make_url(['static','img','skins','default','managerIcons','icon_access.png'])}) no-repeat 0px 0;"></a>
          <dd>You do not have the necessary capabilities required to edit the log review configuration.  Please contact your Splunk administrator.</dd>
        </div>
      </div>
    </div>
  </div>
% endif