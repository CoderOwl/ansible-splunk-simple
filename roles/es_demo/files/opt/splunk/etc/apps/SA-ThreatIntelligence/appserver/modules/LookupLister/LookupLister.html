<%page args="module"/>

<%
## Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.
import cherrypy
import csv
import os
import splunk.clilib.bundle_paths as bp

from LookupLister import LookupLister

## Get cherry key
session_key = cherrypy.session.get('sessionKey')

## Get cherry username
user = cherrypy.session['user']['name']

## Get capabilities
capabilities = LookupLister.getCapabilities4User(user, session_key)

## Test capabilities
insufficient_permissions = True

if 'edit_lookups' in capabilities:
    insufficient_permissions = False

## Get app
app = APP['id']

## Get editView
editView = module['params'].get('editView', '')

## Make editorPath
editorPath = ["app", app, editView]

## Make exportPath
exportPath = ["custom", "SA-ThreatIntelligence", "lookupeditor", "load"]

lookups = {}
names_sorted = []
error = None

## Determine where the list of editable lookups is
editableLookupsRelative = module['params'].get( 'editableLookups', '' )

if len( editableLookupsRelative.strip() ) == 0:
	editableLookups = os.path.join( bp.get_base_path(), app, 'lookups', 'editable_lookups.csv' )
else:
	editableLookups = os.path.join( bp.get_base_path(), editableLookupsRelative)
	
show_export_action = editableLookups.endswith('editable_lookups.csv')
	
## Get the title
title = module['params'].get('title', 'Lookup Files')

if os.path.exists(editableLookups):
    with open(editableLookups, 'rb') as f:
        try:
            for row in csv.DictReader(f):
                label = row.pop('label').strip()
                lookups[label] = row
        except Exception, e:
            error = _('Error while reading the list of editable lookups. ' + e)
    names_sorted = sorted(lookups.keys())
else:
    error = _('Unable to find the list of editable lookups.')

%>

% if error:
    <div class="error">${error|h}<div>
    <% return %>
% endif

<div class="adminContent">
    <div class="adminContentList">

		## ---------------------------
		## Page header
		## ---------------------------		
		<div class="eaiPagination">
			<div class="eaiPaginationHeader splClearfix">
				<h2 class="title">${title|h}</h2>
				<!-- 
				<div class="actionButtons">
					<a target="_parent" href="/manager/${app|h}/data/lookup-table-files/_new?action=edit" class="splButton-primary">
						<span>Import</span>
					</a>
			    </div>
			     -->
			</div>
		            
			<div></div>
		</div>

        ## ---------------------------
		## Table header
		## ---------------------------
		<div class="listWrapper">
		<table class="splTable">
			<tr>
				<th>List</th>      
				
                <th>Description</th>
        
                % if show_export_action and not insufficient_permissions:
				<th>Actions</th>
                % endif
			</tr>

		## ---------------------------
		## Search list
		## ---------------------------
		% for name in names_sorted:
            <%
                lookup = lookups[name]
                editorUrl = make_url(editorPath, _qs={'path':lookup.get('path')})
                exportUrl = make_url(exportPath, _qs={'namespace':app, 'path':lookup.get('path'), 'export':1})
            %>
			<tr>
				<td><a href="${editorUrl}">${name|h}</a></td>
				<td>${lookup.get('description')|h}</td>
                
                % if show_export_action and not insufficient_permissions:
                <td><a href="${exportUrl}">Export</a></td>
                % endif
			</tr>
		% endfor
		
		</table>
		</div>
            
	</div>
   
</div>