<%
## Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

import logging
import os
import sys

sys.path.append( os.path.join("..", "..", "..", "bin") )

from notable_event_suppression import NotableEventSuppression
from shortcuts import Invocation, Page, Paginator, NoSessionKeyException

logger = logging.getLogger('splunk.appserver.SA-ThreatIntelligence.modules.NotableEventSuppressionList')

## Get cherry key
session_key = cherrypy.session.get('sessionKey')

## Get cherry username
user = cherrypy.session['user']['name']

## Get capabilities
capabilities = NotableEventSuppression.getCapabilities4User(user, session_key)

## Test capabilities
insufficient_permissions = True

if 'edit_suppressions' in capabilities:
    insufficient_permissions = False

## Get invocation_id
invocation_id = Invocation.getInvocationID()

## Get arguments
args = cherrypy.serving.request.params

def escape_message( msg ):
    return msg.replace("'", "").replace('"', "")

messages = []

## List enabled only
if 'enabled_only' in args:
    enabled_only = args['enabled_only']
else:
    enabled_only = '0'
    
enabled_only = NotableEventSuppression.get_boolean(enabled_only, False)

## Disable the given item
if 'disable' in args:
    action = 'disable'
    suppression_name = args[action]

    try:
        NotableEventSuppression.disable(suppression_name)
        
        status = 'success'
        signature = 'Suppression successfully disabled'
    
        logger.info('invocation_id=%s; suppression=%s; action=%s; status=%s; signature=%s; user=%s;' % (invocation_id, suppression_name, action, status, signature, user)) 
        
        messages.append( {'severity' : 'info', 'message' : signature} )
    
    except Exception as e:
        status = 'failure'
        signature = 'Error occurred while disabling the suppression: ' + str(e)
        
        logger.error('invocation_id=%s; suppression=%s; action=%s; status=%s; signature=%s; user=%s;' % (invocation_id, suppression_name, action, status, signature, user))         
        
        messages.append( {'severity' : 'error', 'message' : signature} )        

## Enable the given item
if 'enable' in args:
    action = 'enable'
    suppression_name = args[action]
    signature = 'Suppression successfully enabled'

    try:
        NotableEventSuppression.enable(suppression_name)
        
        status = 'success'
        signature = 'Suppression successfully enabled'
        
        logger.info('invocation_id=%s; suppression=%s; action=%s; status=%s; signature=%s; user=%s;' % (invocation_id, suppression_name, action, status, signature, user)) 
        
        messages.append( {'severity' : 'info', 'message' : 'Suppression successfully enabled'} )
     
    except Exception as e:
        status = 'failure'
        signature = 'Error occurred while disabling the suppression: ' + str(e)
        
        logger.error('invocation_id=%s; suppression=%s; action=%s; status=%s; signature=%s; user=%s;' % (invocation_id, suppression_name, action, status, signature, user))
        
        messages.append( {'severity' : 'error', 'message' : 'Error occurred while enabling the suppression: ' + str(e)} )

## List the suppressions
suppressions = NotableEventSuppression.get_notable_suppressions()
notable_suppressions = []

if enabled_only:
    for notable_suppression in suppressions:
        if notable_suppression.enabled:
            notable_suppressions.append(notable_suppression)
    
else:
    notable_suppressions = suppressions

## Pagination
offset = 0
items_per_page = 25

if 'count' in args:
    try:
        items_per_page = int(args['count'])
    except ValueError:
        items_per_page = 25

if 'offset' in args:
    try:
        offset = int(args['offset'])
    except ValueError:
        offset = 0
         
paginator = Paginator(len(notable_suppressions), offset, items_per_page)

notable_suppressions = paginator.get_page_contents(notable_suppressions)

app = APP['id']
%>

<%page args="module"/>

<script language="javascript">

     function resultsPerPageChanged(){
        document.location = "?count=" + $('#resultsPerPageSelect').val()
     }

     function hide_disabled() {
         if (document.getElementById('checkbox-enabled_only').checked) {
             document.location = "?enabled_only=1";
         }
         else {
             document.location = "?enabled_only=0";
         }
     }

     $(document).ready(function() {
         $('#resultsPerPageSelect').change( resultsPerPageChanged );
         $('#checkbox-enabled_only').click( hide_disabled );
     });
</script>

<div class="adminContent">

    <script language="javascript">

    var messenger = Splunk.Messenger.System.getInstance();

    % for message in messages:
    messenger.send("${message['severity']}", "splunk.ess", "${escape_message(message['message'])}");
    % endfor
    
    </script>
    
    <div class="adminContentList">
        
        ## ---------------------------
        ## Page header
        ## ---------------------------        
        <div class="eaiPagination">
            <div class="eaiPaginationHeader splClearfix">
                <h2 class="title">Notable Event Suppressions</h2>
                
                <div class="actionButtons">
                    <a target="_parent" href="${make_url(['app', app, module['view_new']])}" class="splButton-primary">
                        <span>New</span>
                    </a>
                </div>
            </div>
                    
            <div></div>
        </div>
        
        ## ---------------------------
        ## Paginator
        ## ---------------------------
        <div class="eaiResultsPageControls splClearfix">
          <div class="eaiResultsPerPage eaiResultsPageControl">
            <label for="resultsPerPageSelect">Results per page</label>
            <select id="resultsPerPageSelect" class="short" name="count">
            % for c in [10, 25, 50, 100]:
              % if c == paginator.entries_per_page:
                <option selected="selected">${c| h}</option>
              % else:
                <option>${c| h}</option>
              % endif
            % endfor
            </select>
          </div>
        
          <p class="eaiResultsCount eaiResultsPageControl">Showing \
            %if len(notable_suppressions) > 0:
              <span>${paginator.offset + 1| h}-${paginator.end_offset_current_page + 1| h}</span> of ${paginator.total_entries| h} items</p>
            %elif len(notable_suppressions) == 0:
              0 items</p>
            %endif
            
    
          <div class="Paginator eaiResultsPageControl">
            <div class="ResultsContainer">
            
              % if paginator.pages_count() > 1:
                <ul>
                % for page in paginator:
                  % if page.is_prev:
                  <li class="previous">
                    <a href="?count=${paginator.entries_per_page| h}&amp;offset=${page.offset| h}">&laquo; previous</a>
                  </li>
                  % elif page.is_next:
                  <li class="next">
                    <a href="?count=${paginator.entries_per_page| h}&amp;offset=${page.offset| h}">next &raquo;</a>
                  </li>
                  % else:
                    % if page.is_current_page:
                  <li class="page active">
                    % else:
                  <li class="page">
                    % endif
                    <a href="?count=${paginator.entries_per_page| h}&amp;offset=${page.offset| h}">${page}</a>
                  </li>
                  % endif
                % endfor
                </ul>
                % endif
            </div>
          </div>
        </div>
        
        ## ---------------------------
        ## Enabled only
        ## ---------------------------
        <div class="checkboxWidget" id="items-enabled_only">
          <div>
              <div class="widgeterror"></div>
              %if enabled_only:
              <input type="checkbox" value="1" id="checkbox-enabled_only" name="enabled_only" class="checkbox proxiable" checked="">
              %else:
              <input type="checkbox" value="1" id="checkbox-enabled_only" name="enabled_only" class="checkbox proxiable">
              %endif
              <label for="checkbox-enabled_only" class="">Enabled suppressions only</label>
          </div>
        </div>
    
        ## ---------------------------
        ## Table header
        ## ---------------------------
        <div class="listWrapper">
        <table class="splTable">
            <tr>
                <th>
                    Name
                </th>      
                <th>
                    Description
                </th>
                <th>
                    Start Time
                </th>
                <th>
                    Expiration Time
                </th>
                <th>
                    Status
                </th>
            </tr>
        
        ## ---------------------------
        ## Search list
        ## ---------------------------
        % for notable_suppression in notable_suppressions:
            <%
                timeStr = '%a %b %d %H:%M:%S %Y'
                startISO = NotableEventSuppression.timeParser(notable_suppression.start)
                endISO = NotableEventSuppression.timeParser(notable_suppression.end)
                
                if startISO:
                    notable_suppression.start = startISO.strftime(timeStr)
                  
                else:
                    notable_suppression.start = ''
                  
                if endISO:
                    notable_suppression.end = endISO.strftime(timeStr)
                
                else:
                    notable_suppression.end = ''           
            %>
            <tr>
                <td><a href="${make_url(['app', app, module['view_edit']])}?id=${notable_suppression.id| h}">${notable_suppression.name| h}</a></td>
                <td>${notable_suppression.description| h}</td>
                <td>${notable_suppression.start| h}</td>
                <td>${notable_suppression.end| h}</td>
                <td>
            % if notable_suppression.enabled:
                % if not insufficient_permissions:
                Enable | <a href="?disable=${notable_suppression.id| h}">Disable</a>
                % else:
                Enabled
                % endif
            % else:
                % if not insufficient_permissions:
                Disable | <a href="?enable=${notable_suppression.id| h}">Enable</a>
                % else:
                Disabled
                % endif
            % endif
                </td>
            </tr>
        % endfor
        
        </table>
        </div>
         
    </div>
</div>